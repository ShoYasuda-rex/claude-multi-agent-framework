# マルチエージェント開発フロー

個人開発で、品質を保ちながら高速開発するためのフレームワーク。

- 1人でチーム相当の開発品質を実現する
- 品質はエージェントによるテスト・静的検証・動的検証で担保する
- 人間はコードを見ない

> **思想**: 要件は変わる。だから仕様は固めない。
> CORE.md で「なぜ作るか」、ARCHITECTURE.md で「どう作るか」を書き、動くものから育てる。

---

## 目次

1. [開発フロー全体像](#開発フロー全体像)
2. [ドキュメント体系](#ドキュメント体系)
3. [ツール一覧](#ツール一覧)
4. [ツール詳細](#ツール詳細)
5. [リリース・障害対応](#リリース障害対応)
6. [付録](#付録)

---

## 開発フロー全体像

```
【起点】
ブラウザ版Claudeで壁打ち → 何を作るかのたたき台

【設計】
1. /kickoff       → たたき台 → docs/CORE.md + docs/ARCHITECTURE.md → プロジェクト初期化

【実装】（コードを書く。まだデプロイしない）
2. /local         → ローカルサーバー起動
3. 実装指示        → 直接実装 or /parallel で並列実装
4. .cc            → コードチェック（実装後、毎回）
5. .vc            → ビジュアルチェック（大きなUI変更時のみ）

【初回リリース】（コードがある状態で）
6. /infra-setup   → Git・GitHub・プラットフォーム・エラー監視・DBバックアップ等（1回きり）
7. /release-setup → 環境変数・外部サービス・本番DB・スモークテスト
8. /audit         → 初回リリース前の一括監査

【デプロイ】
9. /deploy

【リリース後】
10. .test         → テスト整備

【育てる】（機能追加のサイクル）
実装指示 → .cc → .vc（必要なら）→ /deploy → 繰り返し

【随時】
/release-setup  /audit  /deploy safe
```

- 開発補助: `/backup`（git保存）、`/rollback`（巻き戻し）、`/gen-arch`（ドキュメント生成）
- 並列実行: `/parallel`（並列実装）、`/research-team`（UX・コード・競合の3視点調査）

---

## ドキュメント体系

```
docs/BRAINSTORM.md ─── たたき台（ブラウザ版Claudeでの壁打ち結果）
        ↓
docs/CORE.md ───────── Why（誰の課題を・どう解決するか）
        ↓
docs/ARCHITECTURE.md ─ How（技術スタック / 構成 / データモデル / API設計）
        ↓
CLAUDE.md + 実装コード
```

```
docs/current/ ─── コードの実態（/gen-arch で逆引き生成）
├── architecture.md
├── screen-flow.md
└── component-rules.md
```

---

## ツール一覧

### 毎回使う

| コマンド      | 概要                                    |
| --------- | ------------------------------------- |
| `/local`  | ローカルサーバーを起動してブラウザで開く                  |
| `.cc`     | コードチェック（実装後、毎回）                       |
| `.vc`     | ビジュアルチェック（大きなUI変更時）                   |
| `.test`   | テスト生成＋実行（リリース後にテスト整備）                 |
| `/deploy` | git add → commit → push。`safe` で安全モード |

### 設計・初期構築

| コマンド | 概要 |
|---------|------|
| `/kickoff` | 対話で CORE.md + ARCHITECTURE.md を作成・編集 + プロジェクト初期化 |
| `/infra-setup` | 本番の**箱を作る**（Git・GitHub・プラットフォーム・デプロイ設定・ドメイン・DBバックアップ・ブランチ・エラー監視）— 1回きり |
| `/release-setup` | 本番の**中身を整える**（環境変数・外部サービス・DB・スモークテスト）— 毎リリース |

### 並列実行・監査

| コマンド | 概要 |
|---------|------|
| `/parallel` | 並列実装。タスク分割してサブエージェントが同時に実装する |
| `/research-team` | UX・コード品質・競合の3視点で並列調査（実装モード付き） |
| `/audit` | 監査（コード・セキュリティ・設計・法令）を選択して並列実行 |

### ユーティリティ

| コマンド        | 概要                                  |
| ----------- | ----------------------------------- |
| `/backup`   | 現在の状態をgitコミットで保存（pushしない）           |
| `/rollback` | 直近20件から復元先を選択（`reset --hard` は使わない） |
| `/gen-arch` | コード実態からアーキテクチャドキュメントを自動生成           |

### 学習

| コマンド | 概要 |
|---------|------|
| `/feature-trainer` | フロントエンドだけで小さなプロダクトを1日で作り切る（入門） |
| `/fullstack-trainer` | DB+API+Workersでフルスタックプロダクトを2日で作り切る（中級） |
| `/solo-trainer` | 自走で開発を回す練習。次の1手を指示するトレーナー（実践） |

---

## ツール詳細

### /kickoff

**成果物**: docs/CORE.md + docs/ARCHITECTURE.md（なければ新規作成、あれば編集モード）

**CORE.md の構成**:

```markdown
# プロジェクト名
## 誰のためのサービスか
## 何に困っているか
## どうなったら嬉しいか
## なぜ既存の方法ではダメか
## やらないこと
## 一言で言うと
```

**ARCHITECTURE.md の構成**:

```markdown
# プロジェクト名 — アーキテクチャ設計
## 技術スタック
## ディレクトリ構成
## コンポーネント分割
## データモデル
## API設計
## 認証・権限設計
## エラーハンドリング・監視
## やらないこと（技術的スコープ外）
```

**セキュリティレベル**（ヒアリングで確定 → CLAUDE.md に記録）:

| レベル | 内容 |
|-------|------|
| `basic` | 認証なし、外部連携なし |
| `standard` | 認証あり、ユーザーデータ保存あり |
| `strict` | 決済・機密個人情報を扱う |

---

### 検証ツール（.cc / .vc / .test）

3つの検証ツールを、タイミングに応じて使い分ける。

| コマンド | エージェント | 対象 | いつ |
|---------|------------|------|------|
| `.cc` | code-checker | 依存関係・リント・型チェック・ビルド確認（変更ファイル対象） | 実装後、毎回 |
| `.vc` | visual-checker | ブラウザで画面確認 | 大きなUI変更時 |
| `.test` | test-checker | テスト生成＋実行（ユニット・インテグレーション・E2E） | リリース後にテスト整備 |

> **code-checker（.cc）vs audit-code-checker**:
> .cc は変更ファイルの軽量チェック（実装直後用）。
> audit-code-checker はプロジェクト全体の包括的監査（リリース前用）。

**使い分け**:

| 変更スコープ | 推奨 |
|------------|------|
| 小さな修正（typo、CSS微調整） | `.cc` のみ |
| 機能追加・ロジック変更 | `.cc` |
| UI変更を含む | `.cc` + `.vc` |
| リリース後のテスト整備 | `.test` |
| リリース前の包括的チェック | `/audit` |

---

### /audit

選択肢（複数選択可、デフォルト: 全て実行）:

| エージェント                     | 対象             |
| -------------------------- | -------------- |
| audit-code-checker         | コード品質・構造の包括的監査 |
| audit-security-checker     | 脆弱性・認証・秘密情報の検査 |
| audit-architecture-checker | 設計判断の妥当性レビュー   |
| audit-law-checker          | 法令遵守チェック       |

**使い分け**:

| 変更スコープ | 推奨 |
|------------|------|
| UI文言のみ変更 | コード監査のみ |
| 新機能追加 | コード + セキュリティ |
| 認証・決済まわりの変更 | コード + セキュリティ + 設計 |
| LP・広告表現の変更 | 法令 |
| リリース前 | 全て実行 |

---

### /deploy

| モード | 動作 |
|-------|------|
| `/deploy` | 即実行（add → commit → push） |
| `/deploy safe` | 保護ブランチ警告、コンフリクト検出、デプロイ前後にログ自動チェック |

---

### トレーナースキル（学習系）

3段階の学習ステップ: **型を教わる → 型がスケールすると実感 → 自分で回す**

```
/feature-trainer ──→ /fullstack-trainer ──→ /solo-trainer ──→ 本番開発
   入門・1日            中級・2日             実践
```

#### /feature-trainer

フロントエンドのみの小さなプロダクトを1日で作り切り、開発フローの型を身体で覚える。

| 項目 | 内容 |
|------|------|
| 対象 | IT基礎知識なし〜初心者 |
| 技術 | フロントエンドのみ（HTML/CSS/JS, React, Vue等） |
| ホスティング | Cloudflare Pages |
| DB/認証/API | なし |
| 期間 | 1日 |

フロー: テーマ選択 → 環境構築 → スコープ固定 → /kickoff → 実装 → /verify → /deploy → 振り返り

- レベル1〜3のテーマを提示（初回はレベル1推奨）
- 専門用語は初出時に必ず平易な説明を添える
- テーマを変えて繰り返し使える

#### /fullstack-trainer

DB + 外部API + Workersを加えた小さなフルスタックプロダクトを2日で作り切る。

| 項目 | 内容 |
|------|------|
| 対象 | /feature-trainer を1回以上完走した人 |
| フロントエンド | テーマに応じて指定 |
| バックエンド | Cloudflare Workers |
| DB | Cloudflare D1（テーブル2以内） |
| キャッシュ | Cloudflare KV |
| 外部API | 無料API 1つ |
| エンドポイント | 5以内 |
| 認証 | レベル1-2: なし / レベル3: Clerk |
| デプロイ | GitHub Actions による自動デプロイ |
| 期間 | 2日 |

フロー: 前提確認 → テーマ選択 → 環境構築 → スコープ固定 → /kickoff → **DB設計** → 実装 → /verify → /deploy → 振り返り

- feature-trainer と同じ型。道具が増えるだけ
- DB設計フェーズが新規追加（テーブル定義・マイグレーション）
- 外部APIはWorkers経由で呼ぶ（APIキー秘匿・CORS回避）
- テーマを変えて繰り返し使える

#### /solo-trainer

自分でスキルを使って開発を回す練習。トレーナーは横にいて次の1手だけ指示する。

**コアループ**:

```
起動 → 対象を特定 → プロジェクト状態を確認
                ↓
        ┌─【育てるモード】CORE+ARCH+コードあり
        │   CORE/ARCHを読む → 次の機能を2〜3案提案 → ユーザーが選択
        │   → 実装 → .cc → .vc（必要なら）→ /deploy → 繰り返し
        │
        └─【作るモード】新規 or 設計途中
            3択（提案/ヒアリング/ひな形持参）→ テーマ決定
            → /kickoff → /local → 実装 → .cc → ... 既存フロー
                ↓
            完了 → 振り返り
```

**2つのモード**:

| モード | 条件 | 動き |
|--------|------|------|
| 育てる | CORE+ARCH+コードあり | CORE/ARCHを読んで次の機能を提案 → 選択 → 実装サイクルを繰り返す |
| 作る | 新規 or 設計途中 | 3択（提案/ヒアリング/ひな形持参）でテーマ決定 → /kickoff から開始 |

| やること | やらないこと |
|---------|------------|
| 次にやるべきことを1つ指示 | スキル・エージェントの実行 |
| スキルの内容・概念を毎回解説 | ファイルの編集・作成 |
| 育てるモード: CORE/ARCHを読んで機能提案 | コードの中身を読んで評価 |
| よくある失敗パターンの警告 | 設計判断を代わりにする |
| 迷った時の相談 | — |

**トーン**: 「横にいる先輩」。指示は常に1つだけ。スキルを指示するたびに解説を必ず添える。

---

## リリース・障害対応

### 初回リリース

```
/infra-setup    → 箱を作る（1回きり）
/release-setup  → 中身を整える
/audit          → 一括監査
/deploy         → 初回デプロイ
```

### 運用リリース

```
/release-setup  → 差分チェック＆設定補助
/audit          → 一括監査
/deploy safe    → 安全デプロイ
```

### 定期メンテナンス

`/audit` でコード監査・セキュリティ監査を選択して確認

### 障害対応

**検知**: 監視ツール（UptimeRobot / Pushover）、ユーザー報告、`/deploy safe` のログチェック

```
1. 原因特定（ログ・エラー内容を確認）
2. 修正可能か？
   ├─ Yes → 修正 → /verify → /deploy safe
   └─ No  → /rollback
3. rules/learned.md に記録
```

---

## 付録

### A. セットアップ

**ファイル配置**:

```
~/.claude/
├── agents/
│   ├── code-checker.md
│   ├── visual-checker.md
│   ├── test-checker.md
│   ├── audit-code-checker.md
│   ├── audit-security-checker.md
│   ├── audit-architecture-checker.md
│   ├── audit-law-checker.md
│   └── log-checker.md
│
└── skills/
    ├── kickoff/          ├── backup/
    ├── gen-arch/         ├── rollback/
    ├── deploy/           ├── parallel/
    ├── research-team/
    ├── verify/           ├── solo-trainer/
    ├── audit/            ├── feature-trainer/
    ├── local/            └── fullstack-trainer/
    ├── infra-setup/
    └── release-setup/
```

**settings.json**:

- `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS: "1"` — Agent Teams を有効化
- deny/ask リストで危険な操作を制御
- Playwright プラグイン有効

**~/.claude/CLAUDE.md（共通ルール）**:

- 実装タスクのフロー（CORE.md参照 → 依存関係確認 → 設計 → 実装 → 報告）
- 依存関係の確認ルール（変更前に影響範囲を検索）
- エラーの学習（修正したら `rules/learned.md` に記録）

---

### B. 検知カバレッジ

各検証手段が何を検知するかのマトリクス。

#### コード構造・ビルド

| 破壊の種類 | .cc | .vc | .test | audit コード |
|-----------|:---:|:---:|:---:|:---:|
| import/requireの破壊 | ✓ | - | - | ✓ |
| 関数シグネチャ変更 | ✓ | - | ✓ | - |
| 型エラー / ビルドエラー | ✓ | - | - | - |
| リント違反 | ✓ | - | - | ✓ |
| 未使用ファイル・デッドコード | - | - | - | ✓ |
| 循環参照 | - | - | - | ✓ |
| Enum/定数の参照不整合 | - | - | - | ✓ |

#### UI・レイアウト

| 破壊の種類 | .cc | .vc | .test | audit コード |
|-----------|:---:|:---:|:---:|:---:|
| CSSセレクタ不一致 | ✓ | ✓ | - | - |
| レイアウト崩れ（ピクセル） | - | ✓ | - | - |
| レイアウト崩れ（要素・遷移） | - | ✓ | ✓ | - |
| コンソールエラー | - | ✓ | ✓ | - |
| JSランタイムエラー | △ | ✓ | ✓ | - |

#### ルーティング・データ

| 破壊の種類 | .vc | .test | audit コード | deploy ログ |
|-----------|:---:|:---:|:---:|:---:|
| ルーティング破壊 | ✓ | ✓ | ✓ | - |
| APIレスポンスエラー | ✓ | ✓ | - | ✓ |
| DBクエリ破壊 | ✓ | ✓ | - | - |
| 非同期処理の競合 | - | ✓ | - | - |
| データフロー不整合 | - | ✓ | ✓ | - |
| ルート→ハンドラ→ビュー不在 | - | - | ✓ | - |
| モデル/スキーマ不整合 | - | - | ✓ | - |
| データマイグレーション破壊 | - | ✓ | ✓ | ✓ |

#### セキュリティ・インフラ

| 破壊の種類 | .vc | audit コード | audit セキュリティ | deploy ログ |
|-----------|:---:|:---:|:---:|:---:|
| 環境変数欠落 | ✓ | - | ✓ | - |
| ハードコード秘密情報 | - | - | ✓ | - |
| 認証・認可の脆弱性 | - | ✓ | ✓ | - |
| 認証フィルタ適用漏れ | - | ✓ | ✓ | - |
| XSS・インジェクション | - | - | ✓ | - |
| CORS設定ミス | ✓ | - | ✓ | ✓ |
| バージョン整合性・supply chain | - | ✓ | ✓ | - |
| 外部サービス連携の破壊 | - | - | - | - |

#### 本番・パフォーマンス

| 破壊の種類 | .vc | deploy ログ |
|-----------|:---:|:---:|
| 本番クラッシュ・OOM | - | ✓ |
| パフォーマンス劣化（LCP/CLS等） | ✓ | ✓ |
| 502/503/504エラー | - | ✓ |
| キャッシュ破壊・キャッシュ汚染 | ✓ | ✓ |

#### 法令

| 破壊の種類 | audit コード | audit 法令 |
|-----------|:---:|:---:|
| 景品表示法・特商法 | - | ✓ |
| 個人情報保護法 | ✓ | ✓ |
| 著作権・商標 | - | ✓ |

---

### C. モデル配分

| モデル        | 用途                   | ツール                                                                                                                   |
| ---------- | -------------------- | --------------------------------------------------------------------------------------------------------------------- |
| **opus**   | 壁打ち・設計判断・複雑な調査・包括的監査 | kickoff, feature/fullstack/solo-trainer, visual-checker, audit-*, parallel, research-team, infra-setup, release-setup |
| **sonnet** | 構造的な生成・手順実行・差分チェック   | gen-arch, deploy, code-checker, log-checker, rollback                                                                 |
| **haiku**  | 単純な記録・ルックアップ         | local, backup                                                                                                         |
