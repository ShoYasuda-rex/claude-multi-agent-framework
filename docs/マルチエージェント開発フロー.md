## このドキュメントについて

**目的**: 個人開発で、品質を保ちながら高速開発するためのフレームワーク

**前提**:
- 1人でチーム相当の開発品質を実現する
- Web / モバイルアプリ
- 品質はエージェントによる静的検証・動的検証・インテグレーションテストで担保する

**思想**:

要件は変わる。実際に使ってみて、変わる。だから仕様は固めない。

- **CORE.md** — 「なぜ作るか」を書く。誰の課題を・どう解決するか・体験の北極星が対象
- **ARCHITECTURE.md** — 「どう作るか」を書く。技術選定・構成・データモデルが対象
- **最初はモックアップ** — 動くものを作ってから育てる。最初から完璧を目指さない
- **入れすぎない** — ドキュメントが長くなったら、それは書きすぎのサイン

**このフレームワークが存在する理由**:

AIがあっても、流れが決まっていなければ品質はばらつく。このフレームワークはその流れを定義する。

**原則**: AIは「作る・調べる・報告する」。人間は「決める・選ぶ・承認する」。

---

## 自然言語の指示との違い

普段の使い方:

> 「このコードに問題ないか確認して」
> 「3つの機能を作って」
> 「デプロイして」

これでも動く。でも品質がブレる。

| 自然言語で指示 | ショートカットで指示 |
|--------------|-------------------|
| 「コード確認して」→ チェック観点が毎回バラバラ | `.cc` → 専用チェックリストで毎回同じ品質 |
| 「3機能作って」→ 1個ずつ順番に実装 | `.tpi` → タスク分割して並列で同時実装 |
| 「デプロイして」→ いきなりpush | `/deploy safe` → コンフリクト検出・保護ブランチ警告付き |
| 「テスト書いて」→ 何をテストするか曖昧 | `.test` → 変更差分から必要なテストを自動検知 |
| 「セキュリティ大丈夫？」→ 見落とす | `/audit` → 4種の監査を選択して一括実行 |

**自然言語は「何をするか」が毎回ブレる。ショートカットは同じ品質を毎回保証する。**

---

## 使い方

チャット欄にそのまま打つ。それだけ。

2種類ある:

- **ドット系（`.cc`, `.vc` 等）** — 裏でエージェントが動いて結果を返す。会話は中断されない
- **スラッシュ系（`/deploy`, `/local` 等）** — 会話の中で対話しながら進む。確認を求められることがある

打ち方の例:

- `.cc` → コード検証が走り、レポートが返ってくる
- `ログイン画面とダッシュボードを作って .tpi` → 指示の後に付けると、タスク分割して並列実装
- `/deploy safe` → 安全チェック付きでデプロイ

---

## 開発フロー全体像

```
【起点】
アイデアメモ

【設計】
1. /draft-core → docs/CORE.md
2. /draft-arch → docs/ARCHITECTURE.md

【構築】
3. /infra-setup → ARCHITECTURE.mdを読んで運用基盤をセットアップ

【実装・検証】（繰り返す）
4. /local → ローカルサーバー起動
5. .tpi → 並列実装
6. .test → インテグレーションテスト生成
7. .cc → 静的検証 + テスト実行
8. .vc → 動的検証
9. /deploy → デプロイ

【リリース前】
/audit — 一括監査（コード・セキュリティ・設計・法令を並列実行）

【リリース後】
.log — ログ確認

【随時】
/backup — バックアップ

【サポートツール】
/rollback — 緊急時の巻き戻し
/gen-arch — ドキュメント生成
/research-team — 改善調査
/market-team — マーケ調査
```

---

## セットアップ

### ファイル配置

```
~/.claude/
├── agents/
│   ├── code-checker.md
│   ├── visual-checker.md
│   ├── integration-test-gen.md
│   ├── audit-code-checker.md
│   ├── audit-security-checker.md
│   ├── audit-architecture-checker.md
│   ├── audit-law-checker.md
│   └── log-checker.md
│
└── skills/
    ├── draft-core/
    ├── draft-arch/
    ├── gen-arch/
    ├── deploy/
    ├── backup/
    ├── rollback/
    ├── research-team/
    ├── market-team/
    ├── ops-check/
    ├── local/
    ├── feature-trainer/
    ├── fullstack-trainer/
    └── solo-trainer/
```

### settings.json

Claude Code のグローバル設定ファイル（`~/.claude/settings.json`）。権限制御とプラグイン設定を管理する。

- `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS: "1"` — Agent Teams を有効化
- deny/ask リストで危険な操作を制御（機密ファイル読み書き禁止、git push は確認）
- Playwright プラグイン有効

```bash
alias claude-a='claude --dangerously-skip-permissions'
```

### ~/.claude/CLAUDE.md（共通ルール）

全プロジェクト共通で Claude Code が従うルール。以下を定義している:

- ショートカットコマンドの登録（`.tpi`, `.cc` 等 → 対応するエージェントの呼び出し）
- 実装タスクのフロー（CORE.md参照 → 依存関係確認 → 設計 → 実装 → 報告）
- 依存関係の確認ルール（変更前に影響範囲を検索）
- エラーの学習（修正したら `rules/learned.md` に記録）

---

## ツール一覧

| 打ち方 | 何が起きるか |
|--------|------------|
| `.tpi` | 指示をタスクに分割 → 複数エージェントが同時に実装して返す |
| `.cc` | コードの整合性チェック＋テスト実行 → 問題があればレポート |
| `.vc` | ブラウザで実際に画面を開いて動作確認 → スクショ付きレポート |
| `.test` | 変更したコードを分析 → 必要なテストコードを自動生成 |
| `.log` | 本番ログを分析 → エラーや異常の兆候を報告 |
| `/draft-core` | 対話でヒアリング →「なぜ作るか」を docs/CORE.md に整理 |
| `/draft-arch` | 対話でヒアリング → 技術設計を docs/ARCHITECTURE.md に整理 |
| `/deploy` | git add → commit → push を一括実行（`safe` で安全モード付き） |
| `/local` | ローカルサーバーを起動してブラウザで開く |
| `/backup` | 今の状態をgitコミットで保存（pushはしない） |
| `/rollback` | 過去のコミット一覧から選んで巻き戻す |
| `/audit` | 監査系エージェント（コード・セキュリティ・設計・法令）を選択して並列実行 |
| `/infra-setup` | 本番インフラの初期セットアップ & 検証（DB・監視・エラー通知・ブランチ戦略） |
| `/gen-arch` | 今のコードからアーキテクチャドキュメントを自動生成 |
| `/research-team` | UX・コード・競合の3視点で並列調査 → 統合レポート |
| `/market-team` | 訴求・チャネル・競合の3視点でマーケ調査 → 戦略提案 |
| `/feature-trainer` | 開発フローの型をガイド付きで練習 |
| `/fullstack-trainer` | フルスタック開発の型をガイド付きで練習 |
| `/solo-trainer` | 自走で開発を回す練習。次の1手を指示するトレーナー |

---

## ツール詳細

### /draft-core

**成果物**: docs/CORE.md（なければ新規作成、あれば編集モード）

```markdown
# プロジェクト名
## 誰のためのサービスか
## 何に困っているか
## どうなったら嬉しいか
## なぜ既存の方法ではダメか
## 体験の北極星
### トーン & マナー
### 判断の方針
### やってはいけない体験
## やらないこと
## 一言で言うと
```

### /draft-arch

**成果物**: docs/ARCHITECTURE.md（なければ新規作成、あれば編集モード。引数にファイルパスを渡すとインポートモード）

**セキュリティレベル**（ヒアリングで確定 → CLAUDE.mdに記録）:
- `basic`: 認証なし、外部連携なし
- `standard`: 認証あり、ユーザーデータ保存あり
- `strict`: 決済・機密個人情報を扱う

```markdown
# プロジェクト名 — アーキテクチャ設計
## 技術スタック
## ディレクトリ構成
## コンポーネント分割
## データモデル
## API設計
## 認証・権限設計
## やらないこと（技術的スコープ外）
```

### .tpi

**自動選択ロジック**:
- 全タスクが独立 → サブエージェント並列
- タスク間に依存関係あり or 動的にタスクが増える → Agent Teams（共有タスクリスト、Lead常時インタラクティブ）

### .test

変更差分からテストが必要な箇所を検知・生成する。実行はしない。

**生成対象（2層）**:
- **インテグレーションテスト** — API連携・DB操作・非同期処理・外部サービス連携の検証
- **クリティカルパスE2E** — ユーザーの主要導線（ログイン→主要画面遷移→主要操作）の回帰検証

**生成先**: `tests/integration/`, `tests/e2e/`（既存テストは上書きしない）

### /audit

監査エージェントを選択して並列実行する。選択肢:

- 全部実行（コード + セキュリティ + アーキテクチャ + 法令）
- コード監査（audit-code-checker）
- セキュリティ監査（audit-security-checker）
- アーキテクチャ監査（audit-architecture-checker）
- 法令チェック（audit-law-checker）

選択されたエージェントをバックグラウンドで並列起動し、全完了後に統合レポートを出す。

### /deploy

- `/deploy` — 即実行
- `/deploy safe` — 安全バリデーション + ユーザー確認付き（保護ブランチ警告、コンフリクト検出）

### /rollback

直近20件のコミット履歴から復元先を選択。`git reset --hard` は使わない。

---

## テスト戦略

テストコードとして残すのは**インテグレーションテスト**と**クリティカルパスE2E**の2層。それ以外はエージェントが検証する。

| 従来のテスト | 代替 | 方式 |
|------------|------|------|
| ユニットテスト | `.cc` | テストコードは書かず、静的検証で代替 |
| E2Eテスト（網羅） | `.vc` | テストコードは書かず、Playwrightで実際に動かして代替 |
| E2Eテスト（主要導線） | `.test` | クリティカルパスのみテストコードとして残す（回帰防止） |
| インテグレーションテスト | `.test` | AIがテストコードを生成 |

**なぜ2層か**: `.cc`は静的推論、`.vc`は手動トリガー。どちらも「前回動いたものが今も動くか」を保証しない。テストコードだけが回帰を機械的に検証できる。

**フロー**: 実装 → `.test`（インテグレーション + クリティカルパスE2E生成） → `.cc`（静的検証 + テスト実行） → `.vc`（必要時）

### 検知カバレッジ

| 破壊の種類 | .cc | .vc | /audit コード | /audit セキュリティ | .test | .log | /audit 法令 |
|-----------|-----|-----|-------------|------------------|-----|------|------------|
| import/requireの破壊 | ✓ | - | ✓ | - | - | - | - |
| CSSセレクタ不一致 | ✓ | ✓ | - | - | - | - | - |
| 関数シグネチャ変更 | ✓ | - | - | - | ✓ | - | - |
| ルーティング破壊 | - | ✓ | ✓ | - | ✓(E2E) | - | - |
| レイアウト崩れ（ピクセル単位） | - | ✓ | - | - | - | - | - |
| レイアウト崩れ（要素の存在・遷移） | - | ✓ | - | - | ✓ | - | - |
| JSランタイムエラー | △ | ✓ | - | - | ✓ | - | - |
| APIレスポンスエラー | - | ✓ | - | - | ✓ | ✓ | - |
| DBクエリ破壊 | - | ✓ | - | - | ✓ | - | - |
| 環境変数欠落 | - | ✓ | - | ✓ | - | - | - |
| コンソールエラー | - | ✓ | - | - | ✓ | - | - |
| リント違反 | ✓ | - | ✓ | - | - | - | - |
| 非同期処理の競合・順序破壊 | - | - | - | - | ✓ | - | - |
| データフロー不整合 | - | - | ✓ | - | ✓ | - | - |
| 外部サービス連携の破壊 | - | - | - | - | ✓ | - | - |
| 未使用ファイル・デッドコード | - | - | ✓ | - | - | - | - |
| 循環参照 | - | - | - | ✓ | - | - | - |
| ハードコード秘密情報 | - | - | - | ✓ | - | - | - |
| 型エラー | ✓ | - | - | - | - | - | - |
| ビルドエラー | ✓ | - | - | - | - | - | - |
| インテグレーションテスト失敗 | ✓ | - | ✓ | - | - | - | - |
| バージョン整合性（EOL・互換性） | - | - | - | ✓ | - | - | - |
| supply chain脆弱性 | - | - | - | ✓ | - | - | - |
| 認証・認可の脆弱性 | - | - | ✓ | ✓ | - | - | - |
| XSS・インジェクション | - | - | - | ✓ | - | - | - |
| ルート→ハンドラ不在 | - | - | ✓ | - | - | - | - |
| ハンドラ→ビュー不在 | - | - | ✓ | - | - | - | - |
| ビュー変数の未設定 | - | - | ✓ | - | - | - | - |
| モデル/スキーマ不整合 | - | - | ✓ | - | - | - | - |
| 認証フィルタ適用漏れ | - | - | ✓ | ✓ | - | - | - |
| Enum/定数の参照不整合 | - | - | ✓ | - | - | - | - |
| 本番クラッシュ・OOM | - | - | - | - | - | ✓ | - |
| レスポンスタイム劣化 | - | - | - | - | - | ✓ | - |
| 502/503/504エラー | - | - | - | - | - | ✓ | - |
| 景品表示法違反 | - | - | - | - | - | - | ✓ |
| 特商法表記の不備 | - | - | - | - | - | - | ✓ |
| 個人情報保護法違反 | - | - | - | ✓ | - | - | ✓ |
| 著作権・商標の問題 | - | - | - | - | - | - | ✓ |

---

## ドキュメント体系

```
docs/CORE.md（Why）
  誰の課題を・どう解決するか + 体験の北極星
      ↓
docs/ARCHITECTURE.md（How）
  技術スタック / 構成 / データモデル / API設計
      ↓
CLAUDE.md + 実装コード

────────────────────────────
docs/current/（今のコードの実態 — /gen-arch で逆引き生成）
├── architecture.md
├── screen-flow.md
└── component-rules.md
```

---

## リリースフロー

### 初回リリース

```
1. /infra-setup → 本番運用の準備確認
2. /audit → 一括監査（コード・セキュリティ・設計・法令を並列実行）
3. /deploy safe → 安全デプロイ
4. .log → デプロイ後のログ確認
```

### 通常リリース

```
1. /audit → 一括監査（コード・セキュリティ・設計・法令を並列実行）
2. /deploy safe → 安全デプロイ
3. .log → デプロイ後のログ確認
```

### 定期メンテナンス

```
.log → 予兆検知（エラー率上昇・レスポンスタイム劣化）
/audit → コード監査・セキュリティ監査を選択して定期確認
```

---

## 障害対応フロー

### 検知

- 監視ツール（UptimeRobot / Sentry）からのアラート
- ユーザー報告
- `.log` の定期実行で予兆検知

### 対応

```
1. .log → 原因特定
2. 判断: 修正可能か？ → No: /rollback → 4へ
3. 修正した場合:
   a. .test → テスト生成（再発防止）
   b. .cc → 静的検証 + テスト実行
   c. .vc → 動的検証
   d. /deploy safe → 安全デプロイ
   e. .log → 復旧確認
4. rules/learned.md に記録
```

---

## モデル配分

| モデル | ツール |
|-------|-------|
| **opus** | draft-core, draft-arch, research-team, market-team, feature-trainer, fullstack-trainer |
| **sonnet** | gen-arch, deploy, integration-test-gen, log-checker, audit-law-checker |
| **haiku** | local, backup, rollback, solo-trainer |

**基準**: 壁打ち・設計判断・複雑な調査 → opus。構造的な生成・手順実行 → sonnet。単純な記録・ルックアップ → haiku。

